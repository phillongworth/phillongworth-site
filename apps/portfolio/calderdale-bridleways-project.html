<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calderdale Bridleways - Cycling Log</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .map-controls {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .map-controls .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .radio-group {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 8px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            cursor: pointer;
            font-size: 0.85rem;
            color: #495057;
        }

        .radio-group label:hover {
            background: #f8fafc;
        }

        .radio-group input[type="radio"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }

        .unit-toggle-inline {
            margin-top: 12px;
        }

        .unit-toggle-inline label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #495057;
        }

        .unit-toggle-inline input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        /* Stats panel */
        #stats-panel {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        #stats-panel .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        #stats-panel .stat-label {
            color: #6c757d;
        }

        #stats-panel .stat-value {
            font-weight: 600;
            color: #212529;
        }

        #stats-panel .stat-highlight {
            background: #e8f5e9;
            margin: 5px -8px;
            padding: 8px;
            border-radius: 4px;
        }

        #stats-panel .stat-highlight .stat-value {
            color: #2d5016;
            font-size: 1.1em;
        }

        #stats-panel .stat-group {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }

        #stats-panel .stat-group-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .status-ridden {
            color: #f59e0b;
            font-weight: 600;
        }

        .status-not-ridden {
            color: #2563eb;
            font-weight: 600;
        }

        /* Leaflet popup styling */
        .leaflet-popup-content {
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .leaflet-popup-content strong {
            color: #2d5016;
        }

        .path-popup-content {
            min-width: 200px;
        }

        .path-popup-content .popup-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .path-popup-content .popup-row:last-child {
            border-bottom: none;
        }

        .path-popup-content .popup-label {
            color: #6c757d;
        }

        .path-popup-content .popup-divider {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #e9ecef;
        }

        /* Legend */
        .legend {
            background: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-size: 0.8rem;
            line-height: 1.8;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        /* Layer toggles control */
        .layer-toggles {
            background: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-size: 0.8rem;
        }

        .layer-toggles strong {
            display: block;
            margin-bottom: 8px;
        }

        .layer-toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            cursor: pointer;
        }

        .layer-toggle-item:hover {
            background: #f8f9fa;
            margin: 0 -8px;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .layer-toggle-item input[type="checkbox"],
        .layer-toggle-item input[type="radio"] {
            width: 14px;
            height: 14px;
            margin: 0;
            cursor: pointer;
        }

        .toggle-color {
            width: 16px;
            height: 4px;
            border-radius: 2px;
        }

        .layer-divider {
            margin: 8px 0;
            border: none;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <main class="container">
        <section class="project-header header-indigo">
            <h1>Calderdale Bridleways</h1>
            <p>Riding all the bridleways in Calderdale</p>
        </section>

        <section class="project-details">
            <h2>Project Details</h2>
            <p>A challenge to ride every bridleway, restricted byway, and byway open to all traffic (BOAT) in the Calderdale district. Progress is tracked using GPX ride data matched against the official rights of way network.</p>

            <div id="map"></div>

            <div class="map-controls">
                <div class="control-group">
                    <h3>Coverage Status</h3>
                    <div class="radio-group" id="ridden-filter">
                        <label>
                            <input type="radio" name="ridden" value="all" checked>
                            All bridleways
                        </label>
                        <label>
                            <input type="radio" name="ridden" value="ridden">
                            Ridden only
                        </label>
                        <label>
                            <input type="radio" name="ridden" value="not_ridden">
                            Not ridden only
                        </label>
                    </div>
                    <div class="unit-toggle-inline">
                        <label>
                            <input type="checkbox" id="unit-toggle">
                            Show distances in miles
                        </label>
                    </div>
                </div>
                <div class="control-group">
                    <h3>Statistics</h3>
                    <div id="stats-panel">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <a href="https://map.phillongworth.site/bridleway/" class="button" target="_blank">
                <span>Open Full Bridleway Log</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            </a>
            <a href="index.html" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Back to Projects
            </a>
        </section>
    </main>

    <footer>
        <div class="footer-content">

            <nav>
                <a href="#">---</a>
                <a href="#">---</a>

            </nav>
            <p>This page was last updated on: <span id="last-updated"></span></p>

    <script src="script.js"></script>

        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_BASE = '/bridleway/api';

        const RIDDEN_COLOR = '#f59e0b';
        const NOT_RIDDEN_COLOR = '#2563eb';
        const FILTERED_COLOR = '#8b5cf6';

        let map;
        let pathsLayer;
        let useImperial = false;
        let currentRiddenFilter = 'all';
        let currentBaseLayer;

        const baseMaps = {
            osm: {
                name: 'OpenStreetMap',
                layer: () => L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>',
                    maxZoom: 19
                })
            },
            topo: {
                name: 'OpenTopoMap',
                layer: () => L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
                    maxZoom: 17
                })
            },
            cycle: {
                name: 'CyclOSM',
                layer: () => L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.cyclosm.org">CyclOSM</a> &copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>',
                    maxZoom: 20
                })
            },
            esriSat: {
                name: 'Satellite',
                layer: () => L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '&copy; <a href="https://www.esri.com">Esri</a> &mdash; Sources: Esri, Maxar, Earthstar Geographics',
                    maxZoom: 19
                })
            },
            hybrid: {
                name: 'Satellite + Roads',
                layer: () => L.layerGroup([
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '&copy; <a href="https://www.esri.com">Esri</a>',
                        maxZoom: 19
                    }),
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>',
                        maxZoom: 19,
                        opacity: 0.4
                    })
                ])
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadStats();
            loadPaths(true);
            setupEventListeners();
        });

        function initMap() {
            map = L.map('map').setView([53.765, -1.99], 12);

            currentBaseLayer = baseMaps.osm.layer();
            currentBaseLayer.addTo(map);

            pathsLayer = L.geoJSON(null, {
                style: styleFeature,
                onEachFeature: onEachFeature
            }).addTo(map);

            addLegend();
            addLayerToggles();
        }

        function switchBaseMap(mapKey) {
            if (currentBaseLayer) {
                map.removeLayer(currentBaseLayer);
            }
            currentBaseLayer = baseMaps[mapKey].layer();
            currentBaseLayer.addTo(map);
            currentBaseLayer.bringToBack();
        }

        function styleFeature(feature) {
            const props = feature.properties;
            const isRidden = props.is_ridden || false;
            const coverage = props.coverage_fraction || 0;

            if (currentRiddenFilter === 'ridden' || currentRiddenFilter === 'not_ridden') {
                return {
                    color: FILTERED_COLOR,
                    weight: 3,
                    opacity: 0.8
                };
            }

            const baseColor = isRidden ? RIDDEN_COLOR : NOT_RIDDEN_COLOR;
            const opacity = isRidden ? (0.5 + (coverage * 0.5)) : 0.7;

            return {
                color: baseColor,
                weight: 3,
                opacity: opacity
            };
        }

        function onEachFeature(feature, layer) {
            const props = feature.properties;
            const length = formatDistance(props.length_km);
            const coverage = props.coverage_fraction ? (props.coverage_fraction * 100).toFixed(0) : '0';
            const lastRidden = props.last_ridden_date
                ? new Date(props.last_ridden_date).toLocaleDateString('en-GB')
                : 'Never';

            const content = `
                <div class="path-popup-content">
                    <div class="popup-row">
                        <span class="popup-label">Name:</span>
                        <strong>${props.name || 'Unnamed'}</strong>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Type:</span>
                        <span>${props.path_type || 'Unknown'}</span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Route Code:</span>
                        <span>${props.route_code || '-'}</span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Length:</span>
                        <span>${length}</span>
                    </div>
                    <div class="popup-row popup-divider">
                        <span class="popup-label">Ridden:</span>
                        <span class="${props.is_ridden ? 'status-ridden' : 'status-not-ridden'}">
                            ${props.is_ridden ? 'Yes' : 'No'}
                        </span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Coverage:</span>
                        <span>${coverage}%</span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Last Ridden:</span>
                        <span>${lastRidden}</span>
                    </div>
                </div>
            `;

            layer.bindPopup(content);
        }

        function addLegend() {
            const legend = L.control({ position: 'bottomright' });

            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <strong>Coverage Status</strong><br>
                    <div class="legend-item">
                        <span class="legend-color" style="background: ${RIDDEN_COLOR}"></span>
                        <span>Ridden</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: ${NOT_RIDDEN_COLOR}"></span>
                        <span>Not Ridden</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: ${FILTERED_COLOR}"></span>
                        <span>Filtered</span>
                    </div>
                `;
                return div;
            };

            legend.addTo(map);
        }

        function addLayerToggles() {
            const control = L.control({ position: 'topright' });

            control.onAdd = function() {
                const div = L.DomUtil.create('div', 'layer-toggles');

                const baseMapOptions = Object.entries(baseMaps).map(([key, config]) => `
                    <label class="layer-toggle-item">
                        <input type="radio" name="basemap" value="${key}" ${key === 'osm' ? 'checked' : ''}>
                        <span>${config.name}</span>
                    </label>
                `).join('');

                div.innerHTML = `
                    <strong>Overlays</strong>
                    <label class="layer-toggle-item">
                        <input type="checkbox" id="toggle-bridleways" checked>
                        <span class="toggle-color" style="background: ${NOT_RIDDEN_COLOR}"></span>
                        <span>Bridleways</span>
                    </label>
                    <hr class="layer-divider">
                    <strong>Base Map</strong>
                    ${baseMapOptions}
                `;

                L.DomEvent.disableClickPropagation(div);
                return div;
            };

            control.addTo(map);

            setTimeout(() => {
                document.getElementById('toggle-bridleways').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        map.addLayer(pathsLayer);
                    } else {
                        map.removeLayer(pathsLayer);
                    }
                });

                document.querySelectorAll('input[name="basemap"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        switchBaseMap(e.target.value);
                    });
                });
            }, 0);
        }

        async function loadStats() {
            const panel = document.getElementById('stats-panel');

            try {
                const res = await fetch(`${API_BASE}/stats`);
                const allStats = await res.json();

                const areaData = allStats.by_area['Kirklees'];
                if (!areaData) {
                    panel.innerHTML = '<p>No Calderdale data available</p>';
                    return;
                }

                const totalPaths = areaData.count;
                const totalLengthKm = areaData.length_km;
                const riddenPaths = areaData.ridden_count;
                const notRiddenPaths = areaData.not_ridden_count;
                const riddenLengthKm = areaData.ridden_length_km;
                const notRiddenLengthKm = areaData.not_ridden_length_km;

                const totalLength = formatDistance(totalLengthKm);
                const riddenLength = formatDistance(riddenLengthKm);
                const notRiddenLength = formatDistance(notRiddenLengthKm);

                const overallCoverage = totalPaths > 0
                    ? ((riddenPaths / totalPaths) * 100).toFixed(1)
                    : '0.0';

                let html = `
                    <div class="stat-row">
                        <span class="stat-label">Total Bridleways</span>
                        <span class="stat-value">${totalPaths.toLocaleString()}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Length</span>
                        <span class="stat-value">${totalLength}</span>
                    </div>
                    <div class="stat-row stat-highlight">
                        <span class="stat-label">Overall Coverage</span>
                        <span class="stat-value">${overallCoverage}%</span>
                    </div>
                    <div class="stat-group">
                        <div class="stat-group-title">Coverage</div>
                        <div class="stat-row">
                            <span class="stat-label status-ridden">Ridden</span>
                            <span class="stat-value">${riddenPaths} (${riddenLength})</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label status-not-ridden">Not Ridden</span>
                            <span class="stat-value">${notRiddenPaths} (${notRiddenLength})</span>
                        </div>
                    </div>
                `;

                panel.innerHTML = html;
            } catch (err) {
                console.error('Error loading stats:', err);
                panel.innerHTML = '<p>Error loading statistics</p>';
            }
        }

        async function loadPaths(fitBounds = false) {
            const riddenFilter = document.querySelector('input[name="ridden"]:checked')?.value || 'all';
            currentRiddenFilter = riddenFilter;

            try {
                const params = new URLSearchParams();
                params.append('area', 'Kirklees');

                if (riddenFilter === 'ridden') {
                    params.append('ridden', 'true');
                } else if (riddenFilter === 'not_ridden') {
                    params.append('ridden', 'false');
                }

                const url = `${API_BASE}/paths${params.toString() ? '?' + params.toString() : ''}`;
                const res = await fetch(url);
                const data = await res.json();

                pathsLayer.clearLayers();
                pathsLayer.addData(data);

                if (fitBounds && data.features.length > 0) {
                    map.fitBounds(pathsLayer.getBounds(), { padding: [20, 20] });
                }
            } catch (err) {
                console.error('Error loading paths:', err);
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('input[name="ridden"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    loadPaths();
                });
            });

            document.getElementById('unit-toggle').addEventListener('change', (e) => {
                useImperial = e.target.checked;
                loadStats();
                loadPaths();
            });
        }

        function formatDistance(km) {
            if (km === null || km === undefined) return '-';

            if (useImperial) {
                const miles = km * 0.621371;
                return `${miles.toFixed(2)} mi`;
            }
            return `${km.toFixed(2)} km`;
        }
    </script>
</body>
</html>
